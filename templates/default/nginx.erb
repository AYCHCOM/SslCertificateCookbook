<%

web_service = 'nginx'

ssl_compatibility =
  @ssl_compatibility || node['ssl_certificate']['web']['compatibility']

@ssl_config = node['ssl_certificate']['web'].dup

if (ssl_compatibility.is_a?(String) || ssl_compatibility.is_a?(Symbol)) &&
  node['ssl_certificate']['web'][ssl_compatibility].is_a?(Hash)
  Chef::Mixin::DeepMerge.hash_only_merge!(
    @ssl_config,
    node['ssl_certificate']['web'][ssl_compatibility]
  )
end

if @ssl_config[web_service].is_a?(Hash)
  web_config = @ssl_config.delete(web_service)
  Chef::Mixin::DeepMerge.hash_only_merge!(
    @ssl_config,
    web_config
  )
end

-%>
# ----------------- #
  # SSL Configuration #
  # ----------------- #

  ssl_certificate <%= @ssl_cert %>;
  ssl_certificate_key <%= @ssl_key %>;

  <% if @ssl_config[:description].is_a?(String) -%>
  # <%= @ssl_config[:description] %>
  <% end -%>
  <% if @ssl_config[:protocols].is_a?(String) -%>
  ssl_protocols <%= @ssl_config[:protocols] %>;
  <% end -%>
  <% if @ssl_config[:cipher_suite].is_a?(String) -%>
  ssl_ciphers <%= @ssl_config[:cipher_suite] %>;
  <% end -%>

  <% if @ssl_config[:hsts] -%>
  # Enable this if your want HSTS (recommended)
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
  <% end -%>
